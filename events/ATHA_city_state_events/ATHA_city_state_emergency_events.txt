namespace = city_state_emergency

# Events related to emergencies occurring in city states.

###
# 0001-0100: Mercenary mutiny emergency
# by Rick 'rickinator9' Visser
###
# 0001-0010: Entry point.
#	 0001: Mercenary mutiny entry point.
#	 0002: Mercenary mutiny is communicated to the ruler.
#	 0003: Councilors have to decide which solution to suggest to the ruler.

#region Region
city_state_emergency.0001 = {
	type = character_event
	title = city_state_emergency.0001.t
	desc = city_state_emergency.0001.desc

	theme = martial
	left_portrait = {
		character = ROOT
		animation = ecstasy # TODO: Customize this.
	}
	right_portrait = {
		character = scope:mutiny_ringleader
		animation = ecstasy # TODO: Customize this.
	}

	# trigger = { # TODO
	# 	exists = liege
	# 	liege = {
	# 		# The liege must not be at war and must be in debt. This means that mercs have no way to get money, as in war they would have been able to pillage.
	# 		is_at_war = no
	# 		gold < 0

	# 		# The liege must be a city state and must not already be dealing with the issue.
	# 		has_government = city_state_government
	# 		NOT = { has_emergency_mercenary_mutiny = yes }

	# 		# The liege must have a marshal and that marshal must be this character.
	# 		exists = cp:councillor_marshal
	# 		cp:councillor_marshal = ROOT

	# 		# The liege must have a mercenary company that does not expire within a year.
	# 		any_hired_mercenary = {
	# 			mercenary_company_expiration_days > 365
	# 		}
	# 	}
	# }

	# weight_multiplier = {
	# 	base = 1 # TODO
	# }

	immediate = {
		# Spawn the ringleader of the mutiny.
		hidden_effect = {
			liege = {
				random_sub_realm_county = {
					save_scope_as = origin
				}

				if = {
					limit = {
						exists = capital_province
					}
					capital_province = { save_scope_as = target_location }
				}
				else = {
					location = { save_scope_as = target_location }
				}

				create_character = {
					gender_female_chance = root_soldier_female_chance
					location = scope:target_location
					template = new_warrior_character
					faith = scope:origin.faith
					culture = scope:origin.culture

					save_scope_as = mutiny_ringleader
				}
			}

			add_visiting_courtier = scope:mutiny_ringleader
		}

		# Store the current character as the reporter of the mutiny.
		save_scope_as = mutiny_reporter
	}

	option = {
		name = city_state_emergency.0001.a

		liege = {
			trigger_event = { id = city_state_emergency.0002 days = 4 }
		}
	}
}

city_state_emergency.0002 = {
	type = character_event
	title = city_state_emergency.0002.t
	desc = city_state_emergency.0002.desc

	theme = martial
	left_portrait = {
		character = scope:mutiny_reporter
		animation = ecstasy # TODO: Customize this.
	}
	right_portrait = {
		character = scope:mutiny_ringleader
		animation = ecstasy # TODO: Customize this.
	}

	option = {
		name = city_state_emergency.0002.a

		add_emergency_mercenary_mutiny = yes

		custom_tooltip = CITY_STATE_ISSUES_COUNCIL_CALLED_TOOLTIP
		hidden_effect = {
			every_councillor = {
				trigger_event = city_state_emergency.0003
			}
		}
	}
}

city_state_emergency.0003 = {
	type = character_event
	title = city_state_emergency.0003.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					scope:mutiny_reporter = ROOT
				}
				desc = city_state_emergency.0003.reporter_desc
			}
			desc = city_state_emergency.0003.desc
		}
	}
	theme = martial

	left_portrait = {
		character = scope:liege
		animation = ecstasy # TODO: Customize this.
	}
	right_portrait = {
		character = scope:mutiny_ringleader
		animation = ecstasy # TODO: Customize this.
	}

	# COURT CHAPLAIN OPTIONS
	# Utilise temple gold to pay off the mercenaries.
	option = {
		name = city_state_emergency.0003.court_chaplain.temple_gold
		trigger = { has_council_position = councillor_court_chaplain }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = court_chaplain
			VALUE_ARG = flag:temple_gold
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Falsely interpret omens as bad for the mercenary troops. (Only makes sense if the mercs are from the same religious group?)
	# option = {
	# 	name = city_state_emergency.0003.court_chaplain.false_omens
	# 	trigger = { has_council_position = councillor_court_chaplain }

	# 	add_solution_proposal = {
	# 		ID_ARG = emergency_mercenary_mutiny
	# 		COUNCILLOR_ARG = court_chaplain
	# 		VALUE_ARG = flag:false_omens
	# 		EVENT_ID = city_state_emergency.0004
	# 	}
	# }
	# # No advice.
	# option = {
	# 	name = city_state_emergency.0003.court_chaplain.no_advice
	# 	trigger = { has_council_position = councillor_court_chaplain }

	# 	add_solution_proposal = {
	# 		ID_ARG = emergency_mercenary_mutiny
	# 		COUNCILLOR_ARG = court_chaplain
	# 		VALUE_ARG = flag:none
	# 		EVENT_ID = city_state_emergency.0004
	# 	}
	# }

	# CHANCELLOR OPTIONS
	# Try to enlist the help of a neighbouring city state.
	option = {
		name = city_state_emergency.0003.chancellor.neighbour_help
		trigger = { has_council_position = councillor_chancellor }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = chancellor
			VALUE_ARG = flag:neighbour_help
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Try to discredit the ringleader.
	option = {
		name = city_state_emergency.0003.chancellor.discredit_ringleader
		trigger = { has_council_position = councillor_chancellor }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = chancellor
			VALUE_ARG = flag:discredit_ringleader
			EVENT_ID = city_state_emergency.0004
		}
	}
	# No advice.
	option = {
		name = city_state_emergency.0003.chancellor.no_advice
		trigger = { has_council_position = councillor_chancellor }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = chancellor
			VALUE_ARG = flag:none
			EVENT_ID = city_state_emergency.0004
		}
	}

	# STEWARD OPTIONS.
	# Raise a special tax to pay off the mercenaries.
	option = {
		name = city_state_emergency.0003.steward.special_tax
		trigger = { has_council_position = councillor_steward }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = steward
			VALUE_ARG = flag:special_tax
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Embezzle funds (Theorika or Stratioka) to pay off the mercenaries.
	option = {
		name = city_state_emergency.0003.steward.embezzle_funds
		trigger = { has_council_position = councillor_steward }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = steward
			VALUE_ARG = flag:embezzle_funds
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Offer to settle the mercenaries in our territory.
	option = {
		name = city_state_emergency.0003.steward.settlement
		trigger = { has_council_position = councillor_steward }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = steward
			VALUE_ARG = flag:settlement
			EVENT_ID = city_state_emergency.0004
		}
	}
	# No advice.
	option = {
		name = city_state_emergency.0003.steward.no_advice
		trigger = { has_council_position = councillor_steward }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = steward
			VALUE_ARG = flag:none
			EVENT_ID = city_state_emergency.0004
		}
	}

	# MARSHAL OPTIONS
	# We should strike against the dissidents now!
	option = {
		name = city_state_emergency.0003.marshal.first_strike
		trigger = { has_council_position = councillor_marshal }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = marshal
			VALUE_ARG = flag:first_strike
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Duel the ringleader to kill or discredit him.
	option = {
		name = city_state_emergency.0003.marshal.duel
		trigger = { has_council_position = councillor_marshal }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = marshal
			VALUE_ARG = flag:duel
			EVENT_ID = city_state_emergency.0004
		}
	}
	# Attempt to form the mercenaries into a regiment.
	option = {
		name = city_state_emergency.0003.marshal.regiment
		trigger = { has_council_position = councillor_marshal }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = marshal
			VALUE_ARG = flag:regiment
			EVENT_ID = city_state_emergency.0004
		}
	}
	# No advice.
	option = {
		name = city_state_emergency.0003.marshal.no_advice
		trigger = { has_council_position = councillor_marshal }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = marshal
			VALUE_ARG = flag:none
			EVENT_ID = city_state_emergency.0004
		}
	}

	# SPYMASTER OPTIONS
	# We should kill the ringleader.
	option = {
		name = city_state_emergency.0003.spymaster.assassinate_ringleader
		trigger = { has_council_position = councillor_spymaster }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = spymaster
			VALUE_ARG = flag:assassinate_ringleader
			EVENT_ID = city_state_emergency.0004
		}
	}
	# We should assassinate ALL mercenaries.
	option = {
		name = city_state_emergency.0003.spymaster.kill_mercenaries
		trigger = { has_council_position = councillor_spymaster }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = spymaster
			VALUE_ARG = flag:kill_mercenaries
			EVENT_ID = city_state_emergency.0004
		}
	}
	# We should bribe the ringleader.
	option = {
		name = city_state_emergency.0003.spymaster.bribe_ringleader
		trigger = { has_council_position = councillor_spymaster }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = spymaster
			VALUE_ARG = flag:bribe_ringleader
			EVENT_ID = city_state_emergency.0004
		}
	}
	# No advice.
	option = {
		name = city_state_emergency.0003.spymaster.no_advice
		trigger = { has_council_position = councillor_spymaster }

		add_solution_proposal = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = spymaster
			VALUE_ARG = flag:none
			EVENT_ID = city_state_emergency.0004
		}
	}
}

city_state_emergency.0004 = {
	type = character_event
	title = city_state_emergency.0004.t
	desc = {
		desc = city_state_emergency.0004.preface_desc
		first_valid = {
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_court_chaplain
						var:emergency_mercenary_mutiny_proposal_court_chaplain = flag:temple_gold
					}
				}
				desc = city_state_emergency.0004.court_chaplain.temple_gold
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_court_chaplain
						var:emergency_mercenary_mutiny_proposal_court_chaplain = flag:false_omens
					}
				}
				desc = city_state_emergency.0004.court_chaplain.false_omens
			}
			desc = city_state_emergency.0004.court_chaplain.no_advice
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_chancellor
						var:emergency_mercenary_mutiny_proposal_chancellor = flag:neighbour_help
					}
				}
				desc = city_state_emergency.0004.chancellor.neighbour_help
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_chancellor
						var:emergency_mercenary_mutiny_proposal_chancellor = flag:discredit_ringleader
					}
				}
				desc = city_state_emergency.0004.chancellor.discredit_ringleader
			}
			desc = city_state_emergency.0004.chancellor.no_advice
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_steward
						var:emergency_mercenary_mutiny_proposal_steward = flag:special_tax
					}
				}
				desc = city_state_emergency.0004.steward.special_tax
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_steward
						var:emergency_mercenary_mutiny_proposal_steward = flag:embezzle_funds
					}
				}
				desc = city_state_emergency.0004.steward.embezzle_funds
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_steward
						var:emergency_mercenary_mutiny_proposal_steward = flag:settlement
					}
				}
				desc = city_state_emergency.0004.steward.settlement
			}
			desc = city_state_emergency.0004.steward.no_advice
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_marshal
						var:emergency_mercenary_mutiny_proposal_marshal = flag:first_strike
					}
				}
				desc = city_state_emergency.0004.marshal.first_strike
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_marshal
						var:emergency_mercenary_mutiny_proposal_marshal = flag:duel
					}
				}
				desc = city_state_emergency.0004.marshal.duel
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_marshal
						var:emergency_mercenary_mutiny_proposal_marshal = flag:regiment
					}
				}
				desc = city_state_emergency.0004.marshal.regiment
			}
			desc = city_state_emergency.0004.marshal.no_advice
		}
		first_valid = {
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_spymaster
						var:emergency_mercenary_mutiny_proposal_spymaster = flag:assassinate_ringleader
					}
				}
				desc = city_state_emergency.0004.spymaster.assassinate_ringleader
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_spymaster
						var:emergency_mercenary_mutiny_proposal_spymaster = flag:kill_mercenaries
					}
				}
				desc = city_state_emergency.0004.spymaster.kill_mercenaries
			}
			triggered_desc = {
				trigger = {
					primary_title = { 
						has_variable = emergency_mercenary_mutiny_proposal_spymaster
						var:emergency_mercenary_mutiny_proposal_spymaster = flag:bribe_ringleader
					}
				}
				desc = city_state_emergency.0004.spymaster.bribe_ringleader
			}
			desc = city_state_emergency.0004.spymaster.no_advice
		}
	}

	theme = martial
	left_portrait = {
		character = ROOT
		animation = ecstasy # TODO: Customize this.
	}

	immediate = {
		# Set scopes for the councillors to populate localisation.
		every_councillor = {
			if = {
				limit = { has_council_position = councillor_court_chaplain }
				save_scope_as = court_chaplain
			}
			if = {
				limit = { has_council_position = councillor_chancellor }
				save_scope_as = chancellor
			}
			if = {
				limit = { has_council_position = councillor_steward }
				save_scope_as = steward
			}
			if = {
				limit = { has_council_position = councillor_marshal }
				save_scope_as = marshal
			}
			if = {
				limit = { has_council_position = councillor_spymaster }
				save_scope_as = spymaster
			}
		}
	}

	option = {
		name = city_state_emergency.0004.court_chaplain
		trigger = {
			primary_title = { 
				has_variable = emergency_mercenary_mutiny_proposal_court_chaplain
				NOT = { var:emergency_mercenary_mutiny_proposal_court_chaplain = flag:none }
			}
		}
		if = {
			limit = {
				primary_title = { 
					var:emergency_mercenary_mutiny_proposal_court_chaplain = flag:temple_gold
				}
			}

			custom_tooltip = CITY_STATE_CORRUPTION_INCREASE_POTENTIAL_TOOLTIP
		}

		set_solution = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = court_chaplain
		}

		create_story = city_state_mercenary_emergency_story
	}
	option = {
		name = city_state_emergency.0004.chancellor
		trigger = {
			primary_title = { 
				has_variable = emergency_mercenary_mutiny_proposal_chancellor
				NOT = { var:emergency_mercenary_mutiny_proposal_chancellor = flag:none }
			}
		}

		set_solution = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = chancellor
		}
	}
	option = {
		name = city_state_emergency.0004.steward
		trigger = {
			primary_title = { 
				has_variable = emergency_mercenary_mutiny_proposal_steward
				NOT = { var:emergency_mercenary_mutiny_proposal_steward = flag:none }
			}
		}
		if = {
			limit = {
				primary_title = { 
					var:emergency_mercenary_mutiny_proposal_steward = flag:embezzle_funds
				}
			}

			custom_tooltip = CITY_STATE_CORRUPTION_INCREASE_POTENTIAL_TOOLTIP
		}

		set_solution = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = steward
		}
	}
	option = {
		name = city_state_emergency.0004.marshal
		trigger = {
			primary_title = { 
				has_variable = emergency_mercenary_mutiny_proposal_marshal
				NOT = { var:emergency_mercenary_mutiny_proposal_marshal = flag:none }
			}
		}

		set_solution = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = marshal
		}
	}
	option = {
		name = city_state_emergency.0004.spymaster
		trigger = {
			primary_title = { 
				has_variable = emergency_mercenary_mutiny_proposal_spymaster
				NOT = { var:emergency_mercenary_mutiny_proposal_spymaster = flag:none }
			}
		}
		if = {
			limit = {
				primary_title = { 
					var:emergency_mercenary_mutiny_proposal_spymaster = flag:bribe_ringleader
				}
			}

			custom_tooltip = CITY_STATE_CORRUPTION_INCREASE_GUARANTEE_TOOLTIP
		}

		set_solution = {
			ID_ARG = emergency_mercenary_mutiny
			COUNCILLOR_ARG = spymaster
		}
	}
}

#####
#
#	PRIEST STEALS FROM TEMPLE FLAVOUR EVENTS.
#
#####

# The Court Chaplain get caught while stealing from the temple treasury.
city_state_emergency.0005 = {
	type = character_event
	title = city_state_emergency.0005.t
	desc = city_state_emergency.0005.desc

	theme = martial
	left_portrait = {
		character = ROOT
		animation = ecstasy # TODO: Customize this.
	}

	option = {
		name = city_state_emergency.0005.a

		save_scope_as = court_chaplain

		liege = {
			trigger_event = city_state_emergency.0006 
		}
	}
}

city_state_emergency.0006 = {
	type = character_event
	title = city_state_emergency.0006.t
	desc = city_state_emergency.0006.desc

	theme = martial
	left_portrait = {
		character = ROOT
		animation = ecstasy # TODO: Customize this.
	}

	option = {
		name = city_state_emergency.0006.a

		primary_title = {
			change_variable = {
				name = city_state_corruption
				add = 25
			}
		}
	}
}
#endregion